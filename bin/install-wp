#!/bin/bash

function is_db_up() {
    RESULT=`mysql -h ${WORDPRESS_DB_HOST%:*} \
                  -P${WORDPRESS_DB_HOST#*:} \
                  -u ${WORDPRESS_DB_USER} \
                  -p${WORDPRESS_DB_PASSWORD} \
                  --skip-column-names \
                  -e "SHOW DATABASES LIKE '${WORDPRESS_DB_NAME}'" \
                  2>/dev/null`

    if [ "$RESULT" == "${WORDPRESS_DB_NAME}" ]; then
        return 0
    else
        return 1
    fi
}

function test_db_command {
	mysql -h ${WORDPRESS_DB_HOST%:*} \
          -P${WORDPRESS_DB_HOST#*:} \
          -uroot \
          -p${WORDPRESS_DB_PASSWORD} \
          -e "$1"
}

until is_db_up; do
   echo "Waiting for database to become available..."
   sleep 5
done

echo "Database is available. Continuing..."

# Checkout/update WordPress
echo
cd /var/www/html
if [ -d "wordpress/.git" ]; then
	echo "Updating WordPress..."
	git -C wordpress pull
else
    echo "Installing WordPress..."
	git clone https://github.com/xwp/wordpress-develop.git wordpress
fi
cd -

# Copy config files
echo
echo "Adding WordPress Configs..."
cp /var/www/html/wp-config/wp-config.php /var/www/html/wordpress/wp-config.php
cp /var/www/html/wp-config/wp-tests-config.php /var/www/html/wordpress/wp-tests-config.php

if ! $(wp core is-installed --allow-root --path=/var/www/html/wordpress/src); then
    wp core install \
        --allow-root \
        --path=/var/www/html/wordpress/src \
        --url=${WP_DOMAIN} \
        --title="Docker WordPress" \
        --admin_user=${WP_ADMIN_USER} \
        --admin_password="wordpress" \
        --admin_email=${WP_EMAIL} \
        --skip-email
fi

# Ensure the plugin and theme directories exist
mkdir -p /var/www/html/wp-content/themes
mkdir -p /var/www/html/wp-content/plugins

# Checkout/update default theme
echo
echo "Checking out theme..."
if [ -d "../wp-content/themes/twentyseventeen" ]; then
	git -C ../wp-content/themes/twentyseventeen pull
else
	git clone https://github.com/WordPress/twentyseventeen.git ../wp-content/themes/twentyseventeen
fi

echo "Installing Plugins..."

cd /var/www/html/wp-content
composer install
cd -

echo "Activating Plugins..."

wp plugin activate \
	query-monitor \
	--allow-root

echo "Creating Tests Database..."
test_db_command "CREATE DATABASE IF NOT EXISTS ${WP_TESTS_DB_NAME};"

echo "Granting User Privileges..."
test_db_command "GRANT ALL PRIVILEGES ON ${WP_TESTS_DB_NAME}.* TO '${WP_TESTS_DB_USER}'@'%' IDENTIFIED BY '${WP_TESTS_DB_PASSWORD}';"

echo "Flushing Privileges..."
test_db_command "FLUSH PRIVILEGES;"

echo
echo "Done!"

php-fpm -F
